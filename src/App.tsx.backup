import React, { useState } from 'react';
import { initializeIcons } from '@fluentui/react';
import { Stack } from '@fluentui/react/lib/Stack';
import './styles/windows-theme.css';
import ProductInput from './components/ProductInput/ProductInput';
import TotalDisplay from './components/TotalDisplay/TotalDisplay';
import ReceiptView from './components/ReceiptView/ReceiptView';
import LeadCapture from './components/LeadCapture/LeadCapture';
import { useBrand } from './contexts/BrandContext';
import { Product } from './types';

// Inicializar Ã­cones do Fluent UI
initializeIcons();

// FunÃ§Ã£o para calcular o total
const calculateTotal = (products: Product[]): number => {
  return products.reduce((sum, product) => sum + product.total, 0);
};

const AppContent: React.FC = () => {
  const { brand } = useBrand(); // Agora brand Ã© do tipo BrandConfig
  const [products, setProducts] = useState<Product[]>([]);
  const [budget, setBudget] = useState<number>(brand.configuracoes?.orcamentoPadrao || 500);
  const [showLeadCapture, setShowLeadCapture] = useState<boolean>(false);

  const handleAddProduct = (name: string, quantity: number, unitPrice: number) => {
    const total = quantity * unitPrice;
    const newProduct: Product = {
      id: Date.now().toString(),
      name,
      quantity,
      unitPrice,
      total
    };
    setProducts([...products, newProduct]);
  };

  const handleRemoveProduct = (id: string) => {
    setProducts(products.filter(product => product.id !== id));
  };

  const handleSaveList = () => {
    if (products.length > 0) {
      setShowLeadCapture(true);
    } else {
      alert('Adicione produtos antes de salvar a lista!');
    }
  };

  return (
    <div className="window-container">
      <div className="win-title-bar">
        <div>
          <h1 style={{ margin: 0, fontSize: '24px', fontWeight: 600, color: brand.cores.primaria }}>
            ðŸ›’ {brand.nome}
          </h1>
          <div style={{ color: brand.cores.texto + '80', fontSize: '14px' }}>
            {brand.slogan || 'NÃ£o estoure seu orÃ§amento!'}
          </div>
        </div>
        {products.length > 0 && (
          <button 
            onClick={handleSaveList}
            style={{
              backgroundColor: brand.cores.primaria,
              color: 'white',
              border: 'none',
              padding: '8px 16px',
              borderRadius: '4px',
              cursor: 'pointer',
              fontWeight: '600'
            }}
          >
            ðŸ’¾ Salvar Minha Lista
          </button>
        )}
      </div>

      <Stack tokens={{ childrenGap: 20 }}>
        <div style={{ display: 'flex', gap: '20px', flexWrap: 'wrap' }}>
          <div style={{ flex: '1 1 300px' }}>
            <ProductInput onAddProduct={handleAddProduct} />
          </div>
          <div style={{ flex: '1 1 300px' }}>
            <TotalDisplay 
              total={calculateTotal(products)} 
              budget={budget} 
              onBudgetChange={setBudget}
              primaryColor={brand.cores.primaria}
            />
          </div>
        </div>

        <ReceiptView 
          products={products}
          onRemoveProduct={handleRemoveProduct}
          total={calculateTotal(products)}
        />

        {showLeadCapture && (
          <LeadCapture
            brand={brand}
            products={products}
            total={calculateTotal(products)}
            onClose={() => setShowLeadCapture(false)}
          />
        )}
      </Stack>

      <div style={{ 
        marginTop: '30px', 
        paddingTop: '15px', 
        borderTop: '1px solid #edebe9',
        fontSize: '12px',
        color: '#605e5c',
        textAlign: 'center'
      }}>
        <p>Ferramenta fornecida por <strong>{brand.nome}</strong>.</p>
        <p>WhatsApp: {brand.contato.whatsapp} | Email: {brand.contato.email}</p>
      </div>
    </div>
  );
};

// Componente principal
const App: React.FC = () => {
  return <AppContent />;
};

export default App;
